<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Eyes Up Adventures – Maine 48‑Hour Snowfall Forecast</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Esri Leaflet adds connectors for ArcGIS services (used for the NWS snowfall forecast) -->
  <script src="https://unpkg.com/esri-leaflet@3.0.8/dist/esri-leaflet.js"></script>
<style>
  /* Remove default margins so the map fills the viewport */
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
    font-family: Arial, sans-serif;
  }
  /* Top header branding */
  .header {
    background-color: #0a4065;
    color: #fff;
    padding: 16px;
    text-align: center;
    font-size: 1.5rem;
    font-weight: bold;
  }
  /* Subheading explaining the data */
  .subheader {
    font-size: 0.9rem;
    font-weight: normal;
    margin-top: 4px;
    color: #f0f8ff;
  }
  /* Map container fills remaining viewport height */
  #map {
    height: calc(100% - 72px);
    width: 100%;
  }
  /* Legend styling */
  .legend {
    position: absolute;
    bottom: 10px;
    left: 10px;
    padding: 10px;
    background: rgba(255,255,255,0.9);
    line-height: 1.4;
    border-radius: 4px;
    font-size: 0.8rem;
    box-shadow: 0 1px 4px rgba(0,0,0,0.3);
  }
  .legend-title {
    font-weight: bold;
    margin-bottom: 6px;
    display: block;
  }
  .legend-item {
    display: flex;
    align-items: center;
    margin-bottom: 4px;
  }
  .legend-color-box {
    width: 14px;
    height: 14px;
    margin-right: 6px;
  }
</style>
</head>
<body>
  <div class="header">
    Eyes Up Adventures: Maine Snowfall Forecast
    <div class="subheader">48‑hour predicted snow accumulation (forecasted, not observed)</div>
  </div>
  <div id="map"></div>
  <div id="legend" class="legend"></div>
  <script>
    // Initialize the map centered on Maine
    const map = L.map('map').setView([45.2538, -69.4455], 6);

    // Create custom panes for each snow category to control drawing order. Higher
    // z-index values ensure that larger snow amounts (which are later in the
    // snowCategories array) are drawn above smaller amounts. The pane names
    // correspond to the category index (e.g., 'snowPane0', 'snowPane1', etc.).
    snowCategories.forEach((cat, i) => {
      const paneName = 'snowPane' + i;
      map.createPane(paneName);
      // Use a base z-index in the 400s so these polygons sit above the base map
      // but below most Leaflet controls. Increment by 1 for each category.
      map.getPane(paneName).style.zIndex = 400 + i;
    });

    // Basemap layer using OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    /*
     * Load the official National Weather Service snowfall forecast.
     *
     * The WSSI "Snow_Amount_Days_1-3" layer previously used on this page
     * represents an impact index and not the actual forecast accumulation.  To
     * display accurate 48‑hour totals we instead pull data from the NWS
     * National Digital Forecast Database (NDFD) via Esri’s hosted service
     * `NDFD_SnowFall_v1`.  This service exposes incremental and cumulative
     * snow amounts at 6‑hour intervals for up to 72 hours.  Here we query
     * the "Accumulation by Time" layer (index 1) and request features for
     * the next 48 hours.  Each feature is styled according to the
     * user‑defined snow depth categories.
     */
    // Define snow depth categories and colors.  Declare this before
    // using it in the snowfall layer so it is available within the
    // closure.  Categories are expressed in inches.
    const snowCategories = [
      { label: 'Trace – 1"', color: '#bdd7e6' },
      { label: '1 – 2"',    color: '#6bafd6' },
      { label: '2 – 3"',    color: '#3282bd' },
      { label: '3 – 4"',    color: '#08529d' },
      { label: '4 – 6"',    color: '#082694' },
      { label: '6 – 8"',    color: '#ffff95' },
      { label: '8 – 12"',   color: '#fec400' },
      { label: '12 – 18"',  color: '#ff8700' },
      { label: '18 – 24"',  color: '#db1400' },
      { label: '24 – 30"',  color: '#9e0000' },
      { label: '30+"',     color: '#680000' }
    ];

    (function addSnowForecastLayer() {
      /*
       * Display the National Weather Service snowfall forecast by querying the
       * “Accumulation by Time” layer (ID 1) from the hosted Esri feature service.
       * This layer contains polygons representing cumulative snow totals over
       * incremental time windows. We set a rolling 48‑hour time window starting
       * now and refresh it hourly to keep the map current.  Features are styled
       * according to their grid_code values, which correspond to specific
       * snowfall ranges:
       *   1  → 0‑1"
       *   2  → 1‑2"
       *   3  → 2‑3"
       *   6  → 3‑6"
       *   12 → 6‑12"
       *   18 → 12‑18"
       *   24 → 18‑24"
       *   36 → 24‑36"
       *   999 → >36"
       *
       * Values falling between our custom categories are mapped to the nearest
       * broader category (e.g., 3‑6" falls into the “4 – 6\"” colour band).
       */
      // Helper function to map grid codes from the feature service to the
      // corresponding index in the snowCategories array. Higher codes
      // correspond to higher snowfall amounts.
      function getCategoryIndex(code) {
        if (code === 1) return 0;      // 0‑1"
        if (code === 2) return 1;      // 1‑2"
        if (code === 3) return 2;      // 2‑3"
        if (code === 6) return 4;      // 3‑6 → 4‑6"
        if (code === 12) return 6;     // 6‑12 → 8‑12"
        if (code === 18) return 7;     // 12‑18"
        if (code === 24) return 8;     // 18‑24"
        if (code === 36) return 9;     // 24‑36 → 24‑30"
        if (code === 999) return 10;   // >36 → 30+"
        return 0;
      }

      const snowLayer = L.esri.featureLayer({
        url: 'https://services9.arcgis.com/RHVPKKiFTONKtxq3/arcgis/rest/services/NDFD_SnowFall_v1/FeatureServer/1',
        // Only fetch the fields we need to reduce bandwidth and improve speed
        fields: ['grid_code', 'label'],
        // Simplify polygons on the server to reduce size; higher values simplify more
        simplifyFactor: 0.35,
        // Request fewer decimal places in geometries for a smaller payload
        precision: 2,
        // Use the canvas renderer for better performance with many polygons
        renderer: L.canvas(),
        onEachFeature: function (feature, layer) {
          const code = feature.properties.grid_code;
          const idx = getCategoryIndex(code);
          const category = snowCategories[idx];
          const label = feature.properties.label || category.label;
          layer.bindTooltip(label, { sticky: true });
        },
        style: function (feature) {
          const code = feature.properties.grid_code;
          const idx = getCategoryIndex(code);
          const category = snowCategories[idx];
          // Assign each polygon to its own pane based on the category index.
          return {
            pane: 'snowPane' + idx,
            color: '#000',
            weight: 0,
            fillColor: category.color,
            fillOpacity: 0.6
          };
        }
      }).addTo(map);
      function updateTimeRange() {
        const now = new Date();
        const end = new Date(now.getTime() + 48 * 60 * 60 * 1000);
        snowLayer.setTimeRange(now, end);
      }
      updateTimeRange();
      setInterval(updateTimeRange, 60 * 60 * 1000);
    })();

    // NOTE: snowCategories are defined at the top of this script and are reused
    // throughout the application for both styling and legend creation.

    // Build the legend HTML
    function createLegend() {
      const legendDiv = document.getElementById('legend');
      let html = '<span class="legend-title">Snow depth (inches)</span>';
      snowCategories.forEach(cat => {
        html += '<div class="legend-item"><span class="legend-color-box" style="background:' + cat.color + ';"></span>' + cat.label + '</div>';
      });
      legendDiv.innerHTML = html;
    }

    createLegend();
  </script>
</body>
</html>
